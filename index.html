<!DOCTYPE html>
<!--
  This Source Code Form is subject to the terms of the Mozilla Public
  License, v. 2.0. If a copy of the MPL was not distributed with this
  file, You can obtain one at http://mozilla.org/MPL/2.0/.
-->
<html lang="zh-CN">
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Extract the original Scratch project from HTML or zip files generated by TurboWarp Packager, forkphorus packager, or HTMLifier.">
    <meta name="theme-color" content="#ff4c4c">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline'">
    <title>Scratch, TurboWarp, forkphorus 和 HTMLifier 解包器</title>
    <style>
      :root {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color: #eee;
          background-color: #111;
          color-scheme: dark;
        }
        a {
          color: #4af;
        }
      }

      h1, h2, h3 {
        font-weight: normal;
      }

      main {
        max-width: 480px;
        margin: auto;
      }

      .code {
        font-family: monospace;
      }

      input[type=file] {
        width: 100%;
      }

      .download-section a {
        display: block;
      }

      .drag-effect {
        opacity: 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        border: 10px dashed rgb(110, 110, 255);
        pointer-events: none;
        transition: .2s opacity;
      }
      .dragging .drag-effect {
        opacity: 1;
      }

      .notice {
        padding: 4px;
        border: 1px solid red;
        background-color: rgba(255, 0, 0, 0.205);
        border-radius: 4px;
      }
    </style>
  </head>

  <body>
    <main>
      <h1>解包器</h1>

      <noscript><p>这个解包器需要 JavaScript 。</p></noscript>

      <p>选择或放置一个 HTML 或 zip 文件，解包程序将尝试提取原始 Scratch 作品。</p>

      <input type="file" class="file-input" accept=".zip, .html" multiple autocomplete="off">

      <p class="download-section"></p>

      <p class="notice">拥有作品的打包版本并不一定意味着您可以合法地解包、使用、修改、重新分发、出售或以其他方式无视著作权法。请咨询作品作者以获取更多信息。</p>

      <h2>支持的打包器</h2>
      <p>解包器可以处理使用以下程序生成的项目：</p>
      <ul>
        <li><a href="https://packager.turbowarp.org/">TurboWarp 打包器</a> - 所有格式，包括 HTML、zip、exe（脚本位置和注释在打包时已丢失）</li>
        <li><a href="https://forkphorus.github.io/packager/">forkphorus 打包器</a> - 所有格式，包括 HTML、zip、NW.js</li>
        <li><a href="https://sheeptester.github.io/htmlifier/">HTMLifier</a> - HTML、zip（HTMLifier 将 Scratch 2 作品转换为 Scratch 3，因此解包的作品可能不准确）</li>
      </ul>

      <h2>报告漏洞</h2>
      <p>在 <a href="https://github.com/TurboWarp/unpackager/issues">Github</a> 上报告漏洞（如文件无法正确解包）。</p>

      <h2>代码</h2>
      <p><a href="https://github.com/TurboWarp/unpackager">原版解包器</a>是<a href="https://github.com/TurboWarp/unpackager">开源的</a>。中文版也是<a href="https://github.com/silverteal/turboWarp-unpackager-chinese">开源的</a></p>

      <h2>隐私</h2>
      <p>所有解包操作在本地完成，作品信息不会上传。</p>

      <h2>我不想让别人解包我的作品</h2>
      <p>从技术上讲：<strong>对不起，做不到。</strong></p>
      <p>从法律上讲，推荐您了解“DRM”，“DMCA”，《中华人民共和国民法典》第1195条，《中华人民共和国著作权法》的相关内容</p>
    </main>

    <div class="drag-effect"></div>

    <script src="dependencies/jszip.min.js"></script>
    <script src="unpackager.js"></script>
    <script>
      (function() {
        'use strict';

        const fileInput = document.querySelector('.file-input');
        const downloadSection = document.querySelector('.download-section');

        const processFile = async (file) => {
          const unpackaged = await unpackage(file);
          const type = unpackaged.type;
          const data = unpackaged.data;
          const name = `${file.name}.${type}`;

          const blob = new Blob([data], {
            type: `application/x.scratch.${type}`
          });
          blob.name = name;
          return blob;
        };

        const processInput = async () => {
          const file = fileInput.files[0];
          if (!file) {
            return;
          }

          while (downloadSection.firstChild) {
            if (downloadSection.firstChild.href) {
              URL.revokeObjectURL(downloadSection.firstChild.href);
            }
            downloadSection.firstChild.remove();
          }

          try {
            for (const file of fileInput.files) {
              const placeholder = document.createElement('span');
              placeholder.textContent = `处理 ${file.name}...`;
              downloadSection.appendChild(placeholder);

              const blob = await processFile(file);

              placeholder.remove();
              const link = document.createElement('a');
              link.href = URL.createObjectURL(blob);
              link.download = blob.name;
              link.textContent = `下载 ${blob.name} (${(blob.size / 1000 / 1000).toFixed(2)}MB)`;
              downloadSection.appendChild(link);
              link.click();
            }
          } catch (e) {
            console.error(e);

            const error = document.createElement('pre');
            error.textContent = (e && e.stack) ? e.stack : e;
            downloadSection.appendChild(error);

            alert(`发生错误，请使用您尝试解包的文件报告此错误。\n\n${e}`);
          }
        };

        fileInput.addEventListener('change', (e) => {
          processInput();
        });

        document.documentElement.addEventListener('drop', (e) => {
          document.documentElement.classList.remove('dragging');
          if (e.dataTransfer.types.includes('Files')) {
            e.preventDefault();
            fileInput.files = e.dataTransfer.files;
            processInput();
          }
        });

        document.documentElement.addEventListener('dragleave', (e) => {
          document.documentElement.classList.remove('dragging');
        });

        document.documentElement.addEventListener('dragover', (e) => {
          if (e.dataTransfer.types.includes('Files')) {
            document.documentElement.classList.add('dragging');
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
          }
        });
      }());
    </script>
  </body>
</html>
