<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Extract the original Scratch project from HTML or zip files generated by TurboWarp Packager, forkphorus packager, or HTMLifier.">
    <meta name="theme-color" content="#ff4c4c">
    <title>TurboWarp, forkphorus 和 HTMLifier 解包器</title>
    <style>
      :root {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          color: #eee;
          background-color: #111;
          color-scheme: dark;
        }
        a {
          color: #4af;
        }
      }

      h1, h2, h3 {
        font-weight: normal;
      }

      main {
        max-width: 480px;
        margin: auto;
      }

      .code {
        font-family: monospace;
      }

      input[type=file] {
        width: 100%;
      }

      .download-section a {
        display: block;
      }

      .drag-effect {
        opacity: 0;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        border: 10px dashed rgb(110, 110, 255);
        pointer-events: none;
        transition: .2s opacity;
      }
      .dragging .drag-effect {
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <main>
      <h1>TurboWarp, forkphorus 和 HTMLifier 解包器</h1>

      <p>选择一个由 <a href="https://packager.turbowarp.org/">TurboWarp Packager</a>, <a href="https://forkphorus.github.io/packager/">forkphorus packager</a>，或者 <a href="https://sheeptester.github.io/htmlifier/">HTMLifier</a> 然后解包器将自动将其解包为 Scratch 作品</p>

      <input type="file" class="file-input" accept=".zip, .html" multiple autocomplete="off">

      <p class="download-section"></p>

      <h2>警告</h2>
      <p>你能使用此工具解包文件并不意味着你能够合法地解包、修改或重新分发作品。我们不就此提供法律建议。</p>
      <p>TurboWarp Packager会从打包的作品中删除注释和脚本排列信息，因此您可能需要手动清理脚本。</p>
      <p>HTMLifier 打包时会将Scratch 2作品转换为Scratch 3，因此这些作品中的某些信息可能会丢失。</p>

      <h2>报告漏洞</h2>
      <p>在 <a href="https://github.com/TurboWarp/unpackager/issues">Github</a> 上报告漏洞（如文件无法正确解包）。</p>

      <h2>代码</h2>
      <p><a href="https://github.com/TurboWarp/unpackager">原版解包器</a>是<a href="https://github.com/TurboWarp/unpackager">开源的</a>。中文版也是<a href="https://github.com/silverteal/turboWarp-unpackager-chinese">开源的</a></p>

      <h2>隐私</h2>
      <p>所有解包操作在本地完成，作品信息不会上传。</p>

      <h2>我不想让别人解包我的作品</h2>
      <p>从技术上来讲：<strong>对不起，做不到。</strong></p>
      <p>从法律上讲，推荐您了解“DRM”，“DMCA”，《中华人民共和国民法典》第1195条，《中华人民共和国著作权法》的相关内容</p>
    </main>

    <div class="drag-effect"></div>

    <script src="dependencies/jszip.min.js"></script>
    <script src="unpackager.js"></script>
    <script>
      (function() {
        'use strict';

        const fileInput = document.querySelector('.file-input');
        const downloadSection = document.querySelector('.download-section');

        const processFile = async (file) => {
          const unpackaged = await unpackage(file);
          const type = unpackaged.type;
          const data = unpackaged.data;
          const name = `${file.name}.${type}`;

          const blob = new Blob([data], {
            type: `application/x.scratch.${type}`
          });
          const url = URL.createObjectURL(blob);

          const link = document.createElement('a');
          link.href = url;
          link.download = name;
          link.textContent = `Download ${name} (${(blob.size / 1000 / 1000).toFixed(2)}MB)`;
          downloadSection.appendChild(link);
          link.click();
        };

        const processInput = async () => {
          const file = fileInput.files[0];
          if (!file) {
            return;
          }

          while (downloadSection.firstChild) {
            URL.revokeObjectURL(downloadSection.firstChild.href);
            downloadSection.firstChild.remove();
          }

          try {
            for (const file of fileInput.files) {
              await processFile(file);
            }
          } catch (e) {
            console.error(e);
            alert(`An error occurred, please report this with the file you tried to unpackage.\n\n${e}`);
          }
        };

        fileInput.addEventListener('change', (e) => {
          processInput();
        });

        document.documentElement.addEventListener('drop', (e) => {
          document.documentElement.classList.remove('dragging');
          if (e.dataTransfer.types.includes('Files')) {
            e.preventDefault();
            fileInput.files = e.dataTransfer.files;
            processInput();
          }
        });

        document.documentElement.addEventListener('dragleave', (e) => {
          document.documentElement.classList.remove('dragging');
        });

        document.documentElement.addEventListener('dragover', (e) => {
          if (e.dataTransfer.types.includes('Files')) {
            document.documentElement.classList.add('dragging');
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
          }
        });
      }());
    </script>
  </body>
</html>
